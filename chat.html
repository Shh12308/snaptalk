<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video Chat App</title>
  <link rel="stylesheet" href="chat.css" />
</head>
<body>
  <div id="videoContainer">
    <div id="remote-player" class="video-slot"></div>
    <div id="local-player" class="video-slot"></div>

    <!-- Preferences Panel -->
    <section id="preferencesPanel">
      <label for="prefGender">Gender:</label>
      <select id="prefGender">
        <option value="">-- Select Gender --</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>



<div id="prelayOverlay" style="display: none;">
  <img id="prelayProfilePic" src="default-profile.jpg" alt="Profile" />
  <h2 id="prelayDisplayName"></h2>
  <p id="prelayDetails"></p>
  <p id="prelayJoke"></p>
  <button id="prelayContinueBtn">Continue</button>
</div>

  

<label for="prefPreferredAge">Preferred Partner Age:</label>
<select id="prefPreferredAge">
  <option value="">-- Select Age --</option>
  <option value="13">13</option>
  <option value="14">14</option>
  <option value="15">15</option>
  <option value="16">16</option>
  <option value="17">17</option>
  <option value="18">18+</option>
</select>


      <label for="prefTopics">Topics:</label>
      <input type="text" id="prefTopics" placeholder="e.g. sports, music, tech" />

    <label for="prefLocation">Country:</label>
<select id="prefLocation">
  <option value="">-- Select Country --</option>
</select>

      <button id="savePrefsBtn">Save Preferences</button>
    </section>

    <!-- Initial Buttons -->
    <div id="initialButtons">
      <button id="startBtn">Start</button>
      <button id="homeBtn">Return Home</button>
      <button id="togglePrefsBtn">Toggle Preferences</button>
    </div>

    <!-- In-Call SVG Buttons -->
    <div id="callButtons" style="display: none;">
      <button id="skipBtn" title="Skip">
        <svg viewBox="0 0 24 24"><path d="M16 12l-6 6v-12z"/></svg>
      </button>
      <button id="endCallBtn" title="End" style="color: #f33;">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#f33"/><path d="M15 9l-6 6M9 9l6 6" stroke="#fff" stroke-width="2"/></svg>
      </button>
      <button id="switchCamBtn" title="Switch Camera">
        <svg viewBox="0 0 24 24"><path d="M20 5h-3.17L15 3H9L7.17 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8z"/></svg>
      </button>
      <button id="toggleCamBtn" title="Toggle Camera">
        <svg id="camOnOffIcon" viewBox="0 0 24 24"><path d="M17 10.5v3l4 4v-11l-4 4zM3 7v10h10l4 4V3L13 7H3z"/></svg>
      </button>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
// --- Firebase Config ---
const firebaseConfig = {
  apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
  authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
  databaseURL: import.meta.env.VITE_FIREBASE_DATABASE_URL,
  projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
  storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
  appId: import.meta.env.VITE_FIREBASE_APP_ID
};


firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

const jokes = [
  "Why donâ€™t skeletons fight each other? They donâ€™t have the guts.",
  "I told my computer I needed a break, and it said 'No problem, Iâ€™ll crash!'",
  "Parallel lines have so much in common. Itâ€™s a shame theyâ€™ll never meet.",
  "Why was the math book sad? Because it had too many problems.",
  "What do you call fake spaghetti? An impasta!",
  "Why did the web developer go broke? Because he used up all his cache.",
  "Why donâ€™t programmers like nature? It has too many bugs.",
  "Why do Java developers wear glasses? Because they donâ€™t C#.",
  "What do you get when you cross a snowman and a dog? Frostbite.",
  "Why did the scarecrow win an award? Because he was outstanding in his field.",
  "Why do cows have hooves instead of feet? Because they lactose.",
  "How does a penguin build its house? Igloos it together.",
  "Why did the bicycle fall over? Because it was two-tired.",
  "Why canâ€™t your nose be 12 inches long? Because then it would be a foot.",
  "What did one ocean say to the other ocean? Nothing, they just waved.",
  "Why did the developer go broke? Because he used up all his JSON.",
  "What do clouds wear under their pants? Thunderwear.",
  "I asked the dog what's two minus two. He said nothing.",
  "Why donâ€™t oysters donate to charity? Because theyâ€™re shellfish.",
  "Why canâ€™t you hear a pterodactyl go to the bathroom? Because the 'P' is silent."
];

function showPrelay(remoteUserData) {
  const joke = jokes[Math.floor(Math.random() * jokes.length)];

  // Extract and sanitize remote user data
  const displayName = remoteUserData?.displayName?.trim() || "Anonymous";
  const age = remoteUserData?.age ? `${remoteUserData.age} yrs` : "Age: N/A";
  const gender = remoteUserData?.gender || "Gender: N/A";
  const location = remoteUserData?.location || "Location: N/A";
  const profilePic = remoteUserData?.profilePicture || "default-profile.jpg";

  // Update DOM elements
  const profilePicEl = document.getElementById("prelayProfilePic");
  const nameEl = document.getElementById("prelayDisplayName");
  const detailsEl = document.getElementById("prelayDetails");
  const jokeEl = document.getElementById("prelayJoke");

  if (profilePicEl) profilePicEl.src = profilePic;
  if (nameEl) nameEl.textContent = displayName;
  if (detailsEl) detailsEl.textContent = `${age} â€¢ ${gender} â€¢ ${location}`;
  if (jokeEl) jokeEl.textContent = `ðŸ˜‚ ${joke}`;

  // Show the overlay
  const overlay = document.getElementById("prelayOverlay");
  if (overlay) overlay.style.display = "flex";
}

const ADMIN_UID = import.meta.env.VITE_ADMIN_UID;
const BAN_DURATION_HOURS = 700;
const BAN_DURATION_MS = BAN_DURATION_HOURS * 60 * 60 * 1000;


const APP_ID = import.meta.env.VITE_AGORA_APP_ID; // Replace with your Agora App ID
const SUPABASE_TOKEN_URL = import.meta.env.VITE_SUPABASE_TOKEN_URL;


// Sightengine API credentials
const SIGHTENGINE_API_USER = import.meta.env.VITE_SIGHTENGINE_API_USER;
const SIGHTENGINE_API_SECRET = import.meta.env.VITE_SIGHTENGINE_API_SECRET;

let agoraClient;
let localAudioTrack;
let localVideoTrack;
let remoteUsers = {};

let currentUserProfile = null;
let currentChannel = null;
let remotePartner = null;

// Moderation interval handler
let moderationInterval = null;

// --- Country selector ---
  const countries = [
    { code: "us", name: "United States", flag: "https://flagcdn.com/us.svg" },
    { code: "gb", name: "United Kingdom", flag: "https://flagcdn.com/gb.svg" },
    { code: "ca", name: "Canada", flag: "https://flagcdn.com/ca.svg" },
    { code: "fr", name: "France", flag: "https://flagcdn.com/fr.svg" },
    { code: "de", name: "Germany", flag: "https://flagcdn.com/de.svg" },
    { code: "jp", name: "Japan", flag: "https://flagcdn.com/jp.svg" },
    { code: "au", name: "Australia", flag: "https://flagcdn.com/au.svg" },
    { code: "in", name: "India", flag: "https://flagcdn.com/in.svg" },
    { code: "br", name: "Brazil", flag: "https://flagcdn.com/br.svg" },
    { code: "za", name: "South Africa", flag: "https://flagcdn.com/za.svg" }
  ];

  document.addEventListener("DOMContentLoaded", () => {
    const countrySelect = document.getElementById("prefLocation");

    countries.forEach(country => {
      const option = document.createElement("option");
     option.value = country.name;
      option.textContent = country.name;

document.getElementById("prelayContinueBtn").addEventListener("click", () => {
  document.getElementById("prelayOverlay").style.display = "none";
});
      countrySelect.appendChild(option);
    });
  });

// --- Anonymous sign-in and initialization ---
auth.signInAnonymously()
  .then(() => {
    const user = auth.currentUser;
    console.log("Signed in as:", user.uid);

    checkBan(user.uid).then(banned => {
      if (banned) {
        window.location.href = "banned.html";
        return;
      }

      loadPreferences(user.uid).then(prefs => {
        currentUserProfile = {
          uid: user.uid,
          displayName: user.uid === ADMIN_UID ? "Admin" : "Guest",
          age: prefs.age || 22,
          gender: prefs.gender || "Male",
          location: prefs.location || "us",
          topics: prefs.topics || "",
          photoURL: "https://via.placeholder.com/100",
          isAdmin: user.uid === ADMIN_UID
        };

        setUserProfile(currentUserProfile).then(() => {
          loadPreferencesUI(currentUserProfile);
          findMatch();
        });
      });
    });
  })
  .catch(err => console.error("Auth error:", err));

// --- Check if user is banned ---
async function checkBan(uid) {
  const snapshot = await database.ref('bannedUsers/' + uid).once('value');
  const data = snapshot.val();
  if (!data) return false;

  const bannedAt = data.timestamp;
  const now = Date.now();
  if (now - bannedAt >= BAN_DURATION_MS) {
    await database.ref('bannedUsers/' + uid).remove();
    return false;
  }
  return true;
}

// --- Save user profile to DB ---
async function setUserProfile(profile) {
  await database.ref('users/' + profile.uid).set({
    displayName: profile.displayName,
    age: profile.age,
    preferredAge: profile.preferredAge,  // New field
    gender: profile.gender,
    location: profile.location,
    topics: profile.topics,
    photoURL: profile.photoURL,
    status: 'available',
    timestamp: Date.now()
  });
}

async function setUserStatus(status) {
  if (!currentUserProfile) return;
  await database.ref('users/' + currentUserProfile.uid + '/status').set(status);
}

// --- Load/save user preferences ---
async function loadPreferences(uid) {
  const snapshot = await database.ref('userPreferences/' + uid).once('value');
  return snapshot.val() || {};
}

async function savePreferences(uid, prefs) {
  await database.ref('userPreferences/' + uid).set(prefs);
}

// --- Load preferences UI ---
// UTIL: Load preferences from localStorage and apply to UI
function loadPreferencesUI() {
  const saved = JSON.parse(localStorage.getItem('chatPrefs') || '{}');

  const genderSelect = document.getElementById('prefGender');
  if (genderSelect && saved.gender) genderSelect.value = saved.gender;

  const ageInput = document.getElementById('prefAge');
  if (ageInput && saved.age) ageInput.value = saved.age;

  const preferredAgeInput = document.getElementById('prefPreferredAge');
  if (preferredAgeInput) preferredAgeInput.value = saved.preferredAge || "13";

  const topicsInput = document.getElementById('prefTopics');
  if (topicsInput && saved.topics) topicsInput.value = saved.topics;

  const locationInput = document.getElementById('prefLocation');
  if (locationInput && saved.location) locationInput.value = saved.location;
}

// UTIL: Save preferences to localStorage (and optionally to server)
function setupSavePrefsHandler() {
  const saveBtn = document.getElementById('savePrefsBtn');
  if (!saveBtn) return;

  saveBtn.onclick = async () => {
    const gender = document.getElementById('prefGender')?.value || '';
    const age = parseInt(document.getElementById('prefAge')?.value) || 22;
    const preferredAge = parseInt(document.getElementById('prefPreferredAge')?.value) || 13;
    const topics = document.getElementById('prefTopics')?.value.trim() || '';
    const location = document.getElementById('prefLocation')?.value || 'us';

    const profile = { gender, age, preferredAge, topics, location };

    // Save to localStorage
    localStorage.setItem('chatPrefs', JSON.stringify(profile));

    // Optional: save to backend if desired
    // if (currentUserProfile?.uid) {
    //   await savePreferences(currentUserProfile.uid, profile);
    //   await setUserProfile({ ...currentUserProfile, ...profile });
    // }

    alert('Preferences saved!');
  };
}

// Init on page load
window.onload = () => {
  loadPreferencesUI();
  setupSavePrefsHandler();
};

// --- Country selector with flags ---
function populateCountrySelector(selectedCode = null) {
  const container = document.getElementById('countrySelector');
  if (!container) return;
  container.innerHTML = '';

  countries.forEach(({ code, name, flag }) => {
    const div = document.createElement('div');
    div.classList.add('country-item');
    div.dataset.code = code;
    div.title = name;
    if (code === selectedCode) div.classList.add('selected');

    div.innerHTML = `
      <img class="country-flag" src="${flag}" alt="${name}" />
      <span>${name}</span>
    `;

    div.addEventListener('click', () => {
      container.querySelectorAll('.country-item').forEach(el => el.classList.remove('selected'));
      div.classList.add('selected');
      document.getElementById('prefLocation').value = code;
    });

    container.appendChild(div);
  });
}

// --- Find a match ---
function findMatch() {
  setUserStatus('searching');
  const usersRef = database.ref('users');

  usersRef.orderByChild('status').equalTo('available').once('value', snapshot => {
    const users = snapshot.val();
    let foundMatch = false;

    for (let userId in users) {
      if (userId === currentUserProfile.uid) continue;
      const partner = users[userId];

      // Only match exact location
      if (partner.location !== currentUserProfile.location) continue;

      // Topic overlap check (basic)
      if (currentUserProfile.topics && partner.topics) {
        if (!partner.topics.toLowerCase().includes(currentUserProfile.topics.toLowerCase()) &&
            !currentUserProfile.topics.toLowerCase().includes(partner.topics.toLowerCase())) {
          continue;
        }
      }

      const minor1 = currentUserProfile.age < 18;
      const minor2 = partner.age < 18;

      if ((minor1 && !minor2) || (!minor1 && minor2)) {
        enableSightengineModeration();
      } else {
        disableSightengineModeration();
      }

      // Preferred Age Filtering (both users should match each other's preferred age)
      const preferredAge1 = currentUserProfile.preferredAge;
      const preferredAge2 = partner.preferredAge;

      // Only match if both user and partner's age falls within each other's preferred age range
      if ((preferredAge1 !== undefined && partner.age < preferredAge1) || (preferredAge2 !== undefined && currentUserProfile.age < preferredAge2)) {
        continue; // Skip if ages don't match the preferred age range
      }

      foundMatch = true;
      currentChannel = createChannelName(currentUserProfile.uid, userId);
      remotePartner = partner;

      setUserStatus('busy');
      database.ref('users/' + userId + '/status').set('busy');

      showPreCallOverlay(partner);
      break;
    }

    if (!foundMatch) {
      console.log("No match found. Retrying in 5 seconds...");
      setTimeout(findMatch, 5000);
    }
  });
}

function createChannelName(uid1, uid2) {
  return [uid1, uid2].sort().join('_');
}

// --- Show pre-call overlay ---
function showPreCallOverlay(partner) {
  const joke = jokes[Math.floor(Math.random() * jokes.length)];
  document.getElementById('matchInfo').textContent =
    `${partner.displayName} â€¢ ${partner.gender}, ${partner.age} â€¢ ${partner.location.toUpperCase()}`;
  document.getElementById('joke').textContent = `"${joke}"`;
  document.getElementById('partnerPhoto').src = partner.photoURL || 'https://via.placeholder.com/100';

  document.getElementById('preCallOverlay').classList.remove('hidden');

  let secondsLeft = 5;
  document.getElementById('countdown').innerText = secondsLeft;

  const countdownInterval = setInterval(() => {
    secondsLeft--;
    document.getElementById('countdown').innerText = secondsLeft;
    if (secondsLeft === 0) {
      clearInterval(countdownInterval);
      document.getElementById('preCallOverlay').classList.add('hidden');
      document.getElementById('chatControls').classList.remove('hidden');
      if (currentUserProfile.isAdmin) {
        showAdminControls();
      }
      startCall(currentChannel);
    }
  }, 1000);
}

function showAdminControls() {
  if (document.getElementById('adminControls')) return;

  const adminControls = document.createElement('div');
  adminControls.id = "adminControls";
  adminControls.style.position = "absolute";
  adminControls.style.bottom = "20px";
  adminControls.style.left = "50%";
  adminControls.style.transform = "translateX(-50%)";
  adminControls.style.zIndex = "1000";
  adminControls.style.display = "flex";
  adminControls.style.flexWrap = "wrap";
  adminControls.style.gap = "6px";
  adminControls.style.background = "rgba(0,0,0,0.7)";
  adminControls.style.padding = "10px";
  adminControls.style.borderRadius = "8px";
  adminControls.style.color = "white";

  adminControls.innerHTML = `
    <button id="kickBtn">Kick</button>
    <button id="banBtn">Ban</button>
    <button id="muteAudioBtn">Mute Audio</button>
    <button id="freezeVideoBtn">Freeze Video</button>
    <button id="screenshotBtn">Screenshot</button>
    <button id="flagUserBtn">Flag</button>
    <button id="banLongBtn">Ban 7 Days</button>
    <button id="viewInfoBtn">View Info</button>
    <button id="panicBtn">Panic! Stop All Calls</button>
    <button id="slowMotionBtn">Slow Motion Mode</button>
    <button id="reverseVoiceBtn">Reverse Voices</button>
    <button id="muteAllBtn">Mute Everyone</button>
    <button id="swapCamsBtn">Swap Cameras</button>
    <button id="freezeFrameBtn">Freeze Frame (Meme)</button>
    <button id="resetBtn">Reset All Pranks</button>
  `;

  document.body.appendChild(adminControls);

  document.getElementById('kickBtn').onclick = kickUser;
  document.getElementById('banBtn').onclick = banUser;

  document.getElementById('muteAudioBtn').onclick = () => {
    const audioTrack = Object.values(remoteUsers)[0]?.audioTrack;
    if (audioTrack) {
      const isEnabled = audioTrack.isPlaying;
      audioTrack.setEnabled(!isEnabled);
      alert(`Remote audio ${isEnabled ? 'muted' : 'unmuted'}`);
    } else {
      alert("No remote audio track found.");
    }
  };

  document.getElementById('freezeVideoBtn').onclick = () => {
    const remoteVideo = document.getElementById("remote-player");
    if (remoteVideo) {
      remoteVideo.style.display = remoteVideo.style.display === "none" ? "block" : "none";
    }
  };

  document.getElementById('screenshotBtn').onclick = async () => {
    const base64 = await captureVideoFrame('remote-player');
    if (base64) {
      const link = document.createElement('a');
      link.href = base64;
      link.download = `screenshot_${Date.now()}.jpg`;
      link.click();
    }
  };

  document.getElementById('flagUserBtn').onclick = async () => {
    if (!remotePartner) return;
    await database.ref('flaggedUsers/' + remotePartner.uid).set({
      timestamp: Date.now(),
      flaggedBy: currentUserProfile.uid
    });
    alert("User flagged for review.");
  };

  document.getElementById('banLongBtn').onclick = () => {
    if (!remotePartner) return;
    database.ref('bannedUsers/' + remotePartner.uid).set({
      timestamp: Date.now(),
      duration: 7 * 24 * 60 * 60 * 1000
    });
    endCall();
    remotePartner = null;
    findMatch();
  };

  document.getElementById('viewInfoBtn').onclick = () => {
    if (!remotePartner) return;
    alert(JSON.stringify(remotePartner, null, 2));
  };

  // Fun prank buttons:

  document.getElementById('panicBtn').onclick = () => {
    alert("ðŸš¨ PANIC MODE ACTIVATED! ðŸš¨ All calls will be disconnected immediately.");
    database.ref('system/stopAllCalls').set(true);
  };

  document.getElementById('slowMotionBtn').onclick = () => {
    alert("ðŸ¦¥ Slow Motion Mode Enabled! Videos will be *extra* laggy.");
    database.ref('system/slowMotion').set(true);
  };

  document.getElementById('reverseVoiceBtn').onclick = () => {
    alert("ðŸ”Š Voices reversed! Good luck understanding anyone.");
    database.ref('system/reverseAudio').set(true);
  };

  document.getElementById('muteAllBtn').onclick = () => {
    alert("ðŸ”‡ Everyone is muted. Shhh!");
    database.ref('system/muteAll').set(true);
  };

  document.getElementById('swapCamsBtn').onclick = () => {
    alert("ðŸŽ¥ Camera swap engaged!");
    // Implement swap logic on server or elsewhere
    database.ref('system/swapCameras').set(Date.now());
  };

  document.getElementById('freezeFrameBtn').onclick = () => {
    alert("ðŸ–¼ï¸ Everyone's video frozen to meme time!");
    database.ref('system/freezeFrame').set("https://i.imgur.com/dQw4w9W.png"); // Meme URL
  };

  document.getElementById('resetBtn').onclick = () => {
    alert("Resetting all prank modes to normal.");
    database.ref('system').set({
      stopAllCalls: false,
      slowMotion: false,
      reverseAudio: false,
      muteAll: false,
      swapCameras: false,
      freezeFrame: null,
    });
  };
}

// --- Start Agora call ---
let agoraClient;
let localAudioTrack;
let localVideoTrack;
let remoteUsers = {};
let currentCameraId = null;
let availableCameras = [];
let isAudioMuted = false;
let isVideoMuted = false;

// === Start Call ===
async function startCall(channel) {
  agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

  setupConnectionListeners();

  agoraClient.on("user-published", async (user, mediaType) => {
    await agoraClient.subscribe(user, mediaType);
    if (mediaType === "video") {
      const remoteVideoTrack = user.videoTrack;
      const remotePlayer = document.getElementById("remote-player");
      remotePlayer.innerHTML = "";
      remoteVideoTrack.play(remotePlayer);
    }
    if (mediaType === "audio") {
      const remoteAudioTrack = user.audioTrack;
      remoteAudioTrack.play();
    }
    remoteUsers[user.uid] = user;
  });

  agoraClient.on("user-unpublished", (user, mediaType) => {
    if (mediaType === "video") {
      const remotePlayer = document.getElementById("remote-player");
      remotePlayer.innerHTML = "";
    }
    delete remoteUsers[user.uid];
  });

  // Get secure token
  const token = await fetchToken(channel, currentUserProfile.uid);

  // Join channel
  await agoraClient.join(APP_ID, channel, token, currentUserProfile.uid);

  // Get available cameras
  availableCameras = await AgoraRTC.getCameras();
  currentCameraId = availableCameras[0]?.deviceId;

  // Create audio and video tracks
  localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
  localVideoTrack = await AgoraRTC.createCameraVideoTrack({ cameraId: currentCameraId });

  // Play local video
  localVideoTrack.play("local-player");

  // Publish tracks
  await agoraClient.publish([localAudioTrack, localVideoTrack]);

  // Start moderation if enabled
  if (moderationInterval) clearInterval(moderationInterval);
  if (shouldModerate()) startModerationLoop();
}

// === Fetch token ===
async function fetchToken(channel, uid) {
  try {
    const res = await fetch(`${SUPABASE_TOKEN_URL}?channel=${channel}&uid=${uid}`);
    if (!res.ok) throw new Error("Failed to fetch token");
    const data = await res.json();
    return data.token || null;
  } catch (e) {
    console.error("Token fetch error:", e);
    return null;
  }
}

// === End call ===
async function endCall() {
  if (localAudioTrack) {
    localAudioTrack.close();
    localAudioTrack = null;
  }
  if (localVideoTrack) {
    localVideoTrack.close();
    localVideoTrack = null;
  }
  if (agoraClient) {
    await agoraClient.leave();
    agoraClient = null;
  }

  document.getElementById("local-player").innerHTML = "";
  document.getElementById("remote-player").innerHTML = "";
  document.getElementById("chatControls").classList.add("hidden");

  setUserStatus("available");
  if (remotePartner) {
    database.ref('users/' + remotePartner.uid + '/status').set('available');
  }
  remotePartner = null;

  disableSightengineModeration();

  findMatch();
}

// === Mute/unmute audio ===
function toggleAudio() {
  if (!localAudioTrack) return;
  isAudioMuted = !isAudioMuted;
  localAudioTrack.setEnabled(!isAudioMuted);
}

// === Mute/unmute video ===
function toggleVideo() {
  if (!localVideoTrack) return;
  isVideoMuted = !isVideoMuted;
  localVideoTrack.setEnabled(!isVideoMuted);
}

// === Switch camera ===
async function switchCamera() {
  if (!availableCameras.length || availableCameras.length < 2) return;
  const nextIndex = (availableCameras.findIndex(cam => cam.deviceId === currentCameraId) + 1) % availableCameras.length;
  currentCameraId = availableCameras[nextIndex].deviceId;

  const newVideoTrack = await AgoraRTC.createCameraVideoTrack({ cameraId: currentCameraId });

  await agoraClient.unpublish(localVideoTrack);
  localVideoTrack.stop();
  localVideoTrack.close();

  localVideoTrack = newVideoTrack;
  localVideoTrack.play("local-player");
  await agoraClient.publish(localVideoTrack);
}

// === Handle reconnects ===
function setupConnectionListeners() {
  agoraClient.on("connection-state-change", (curState, prevState) => {
    console.log(`Connection state changed from ${prevState} to ${curState}`);
    if (curState === "DISCONNECTED") {
      // Optionally alert user or try to reconnect
    }
  });

  agoraClient.on("network-quality", (stats) => {
    console.log("Network quality:", stats);
    // You could show UI feedback based on stats.uplinkNetworkQuality or downlink
  });
}

// --- Sightengine moderation ---

function shouldModerate() {
  if (!currentUserProfile || !remotePartner) return false;
  const minor1 = currentUserProfile.age < 18;
  const minor2 = remotePartner.age < 18;
  return (minor1 && !minor2) || (!minor1 && minor2);
}

function enableSightengineModeration() {
  if (moderationInterval) return; // already running
  console.log("Moderation enabled for minors");

  moderationInterval = setInterval(async () => {
    if (!localVideoTrack) return;

    try {
      // Capture a frame from local video track
      const frame = await captureVideoFrame("local-player");
      if (!frame) return;

      // Call Sightengine API
      const flagged = await analyzeImageSightengine(frame);
      if (flagged) {
        alert("Inappropriate content detected! Ending call.");
        kickUser();
      }
    } catch (err) {
      console.error("Moderation error:", err);
    }
  }, 1000); 
}

function disableSightengineModeration() {
  if (moderationInterval) {
    clearInterval(moderationInterval);
    moderationInterval = null;
    console.log("Moderation disabled");
  }
}

// --- Capture video frame as base64 from a video element ID ---
async function captureVideoFrame(videoElementId) {
  const videoEl = document.getElementById(videoElementId);
  if (!videoEl) return null;
  if (videoEl.tagName.toLowerCase() !== "video") return null;

  const canvas = document.createElement("canvas");
  canvas.width = videoEl.videoWidth || 640;
  canvas.height = videoEl.videoHeight || 480;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(videoEl, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL("image/jpeg");
}

// --- Call Sightengine API to analyze image ---
async function analyzeImageSightengine(base64Image) {
  try {
    const formData = new FormData();
    formData.append('media', base64Image);
    formData.append('api_user', SIGHTENGINE_API_USER);
    formData.append('api_secret', SIGHTENGINE_API_SECRET);
    formData.append('models', 'nudity,wad,offensive');

    const response = await fetch("https://api.sightengine.com/1.0/check.json", {
      method: "POST",
      body: formData
    });
    const result = await response.json();

    if (result.status !== "success") {
      console.error("Sightengine API error:", result);
      return false;
    }

    // Flag if nudity or weapon/abuse detected with moderate or high confidence
    const nudity = result.nudity?.raw || 0;
    const weapon = result.weapon?.prob || 0;
    const offensive = result.offensive?.prob || 0;

    if (nudity >= 0.5 || weapon >= 0.5 || offensive >= 0.5) {
      return true;
    }
    return false;
  } catch (e) {
    console.error("Sightengine API call failed:", e);
    return false;
  }
}

// --- Button handler to end call manually ---
const endCallBtn = document.getElementById('endCallBtn');
if (endCallBtn) {
  endCallBtn.onclick = () => {
    if (confirm("Are you sure you want to end the call?")) {
      endCall();
    }
  };
}

// Optional: clean up on window unload
window.addEventListener('beforeunload', async () => {
  await endCall();
  setUserStatus('offline');
});

// --- Initialize country selector on load ---
document.addEventListener('DOMContentLoaded', () => {
  populateCountrySelector(currentUserProfile?.location || 'us');
});  


</script>
</body>
</html>