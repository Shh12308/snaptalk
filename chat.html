<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Video Chat App</title>
  <link rel="stylesheet" href="chat.css" />

  <!-- Agora Web SDK NG -->
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>

  <!-- Firebase SDK (Optional) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="videoContainer">
    <div id="remote-player" class="video-slot"></div>
    <div id="local-player" class="video-slot"></div>

    <section id="preferencesPanel">
      <label for="prefGender">Gender:</label>
      <select id="prefGender">
        <option value="">-- Select Gender --</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>

      <div id="prelayOverlay" style="display: none;">
        <img id="prelayProfilePic" src="default-profile.jpg" alt="Profile" />
        <h2 id="prelayDisplayName"></h2>
        <p id="prelayDetails"></p>
        <p id="prelayJoke"></p>
        <button id="prelayContinueBtn">Continue</button>
      </div>

      <label for="prefPreferredAge">Preferred Partner Age:</label>
      <select id="prefPreferredAge">
        <option value="">-- Select Age --</option>
        <option value="13">13</option>
        <option value="14">14</option>
        <option value="15">15</option>
        <option value="16">16</option>
        <option value="17">17</option>
        <option value="18">18+</option>
      </select>

      <label for="prefTopics">Topics:</label>
      <input type="text" id="prefTopics" placeholder="e.g. sports, music, tech" />

      <label for="prefLocation">Country:</label>
      <select id="prefLocation">
        <option value="">-- Select Country --</option>
      </select>

      <button id="savePrefsBtn">Save Preferences</button>
    </section>

    <div id="initialButtons">
      <button id="startBtn">Start</button>
      <button id="homeBtn">Return Home</button>
      <button id="togglePrefsBtn">Toggle Preferences</button>
    </div>

    <div id="callButtons" style="display: none;">
      <button id="skipBtn" title="Skip">⏭️</button>
      <button id="endCallBtn" title="End" style="color: #f33;">❌</button>
      <button id="switchCamBtn" title="Switch Camera">🔄</button>
      <button id="toggleCamBtn" title="Toggle Camera">🎥</button>
    </div>
  </div>

<script>
  const APP_ID = "f650f821304b4716b121c25cb662ece4";
  const SUPABASE_TOKEN_URL = "https://hvmqgdupvpifyjtzwauf.supabase.co/functions/v1/quick-worker";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2bXFnZHVwdnBpZnlqdHp3YXVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUxOTAzOTMsImV4cCI6MjA2MDc2NjM5M30.S0i_e_TvpqwWTyE22cWDmEfmJ9yzd4j_Wg5GtHxnzd0"; // Replace this if not using import.meta.env

  let client;
  let localTracks = {};

  async function startCall(channel, uid) {
    client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

    client.on("user-published", async (user, mediaType) => {
      await client.subscribe(user, mediaType);
      if (mediaType === "video") user.videoTrack.play("remote-player");
      if (mediaType === "audio") user.audioTrack.play();
    });

    const tokenRes = await fetch(`${SUPABASE_TOKEN_URL}?channel=${channel}&uid=${uid}`, {
      headers: {
        Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      },
    });

    const tokenData = await tokenRes.json();
    const token = tokenData.token;

    await client.join(APP_ID, channel, token, uid);

    localTracks.audio = await AgoraRTC.createMicrophoneAudioTrack();
    localTracks.video = await AgoraRTC.createCameraVideoTrack();

    localTracks.video.play("local-player");
    await client.publish([localTracks.audio, localTracks.video]);
  }

  function generateChannel() {
    return "channel_" + Math.floor(Math.random() * 1000000);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const startBtn = document.getElementById("startBtn");
    if (!startBtn) return;

    startBtn.addEventListener("click", async () => {
      const channel = generateChannel();
      const uid = Math.floor(Math.random() * 1000000);
      await startCall(channel, uid);
    });
  });
</script>
</body>
</html>