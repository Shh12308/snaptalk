<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snaptalk</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #000; overflow: hidden;
    }
    #videoContainer {
      display: flex; flex-direction: column;
      height: 100%; position: relative;
    }
    #remoteVideo, #localVideo {
      flex: 1; width: 100%; object-fit: cover; background: #000;
    }
    #localVideo { transform: scaleX(-1); }
    #separator {
      height: 2px; background: #fff; width: 100%; z-index: 2;
    }
    #preferences {
      position: absolute; top: 20px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7); padding: 10px;
      border-radius: 8px; color: #fff;
    }
    #preferences select, #preferences input {
      margin: 0 5px;
    }
    #controls {
      position: absolute; bottom: 20px; left: 50%;
      transform: translateX(-50%); display: flex; gap: 20px;
    }
    #controls button {
      background: rgba(255,255,255,0.1);
      border: none; border-radius: 50%;
      width: 50px; height: 50px; display: flex;
      align-items: center; justify-content: center;
      cursor: pointer; transition: background 0.2s;
    }
    #controls button:hover {
      background: rgba(255,255,255,0.3);
    }
    #controls svg { width: 24px; height: 24px; fill: #fff; }
  </style>
</head>
<body>

  <!-- Preferences Panel -->
  <div id="preferences">
    Your Gender:
    <select id="selfGenderSelect">
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
    Your Age:
    <input type="number" id="ageInput" min="13" max="99" placeholder="Age">
    Partner Gender:
    <select id="genderSelect">
      <option value="any">Any</option>
      <option value="male">Male</option>
      <option value="female">Female</option>
    </select>
    Partner Location:
    <select id="locationSelect">
      <option value="any">Any</option>
      <option value="us">US</option>
      <option value="uk">UK</option>
      <option value="in">India</option>
    </select>
  </div>

  <!-- Video Layout -->
  <div id="videoContainer">
    <video id="remoteVideo" autoplay playsinline></video>
    <div id="separator"></div>
    <video id="localVideo" autoplay playsinline muted></video>
  </div>

  <!-- Controls -->
  <div id="controls">
    <!-- Toggle Preferences -->
    <button id="togglePrefsBtn" title="Toggle Preferences">
      <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg>
    </button>

    <!-- Start -->
    <button id="startBtn" title="Start">
      <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </button>

    <!-- Skip -->
    <button id="skipBtn" title="Skip" hidden>
      <svg viewBox="0 0 24 24"><path d="M4 4v16l12-8zM16 4v16h2V4z"/></svg>
    </button>

    <!-- End Call -->
    <button id="endCallBtn" title="End Call" hidden>
      <svg viewBox="0 0 24 24"><path d="M21 7.5a16.88 16.88 0 00-9-2.5 16.88 16.88 0 00-9 2.5l2 2.5A13.9 13.9 0 0112 8a13.9 13.9 0 017 2zM3 10l2 2.5a13.9 13.9 0 007 2 13.9 13.9 0 007-2L21 10a16.88 16.88 0 00-9-2 16.88 16.88 0 00-9 2z"/></svg>
    </button>

    <!-- Switch Camera -->
    <button id="switchCamBtn" title="Switch Camera" hidden>
      <svg viewBox="0 0 24 24"><path d="M20 4h-3.17l-1.83-2H8L6.17 4H4c-1.11 0-1.99.89-1.99 2L2 18a2 2 0 002 2h16a2 2 0 002-2V6c0-1.11-.89-2-2-2zm0 14H4V6h3.05l1.83-2h6.24l1.83 2H20v12zM12 8v4l4-4h-4zm0 8v-4l-4 4h4z"/></svg>
    </button>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io('https://shh1-2.onrender.com');

// Video elements
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');

// Controls
const togglePrefsBtn = document.getElementById('togglePrefsBtn');
const startBtn = document.getElementById('startBtn');
const skipBtn = document.getElementById('skipBtn');
const endCallBtn = document.getElementById('endCallBtn');
const switchCamBtn = document.getElementById('switchCamBtn');

// Preferences
const preferences = document.getElementById('preferences');
const genderSelect = document.getElementById('genderSelect');
const locationSelect = document.getElementById('locationSelect');
const selfGenderSelect = document.getElementById('selfGenderSelect');
const ageInput = document.getElementById('ageInput');

let localStream;
let peerConnection;
let partnerSocketId;
let usingFront = true;

const iceConfig = {
  iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
};

// === BUTTON LOGIC ===

// Toggle Preferences Panel
togglePrefsBtn.onclick = () => {
  preferences.hidden = !preferences.hidden;
};

// Start Chat
startBtn.onclick = async () => {
  await startLocalStream();
  findMatch();

  // Show/Hide buttons
  startBtn.hidden = true;
  skipBtn.hidden = false;
  endCallBtn.hidden = false;
  switchCamBtn.hidden = false;

  preferences.hidden = true;
};

// Skip Partner
skipBtn.onclick = () => {
  endCall();
  findMatch();
};

// End Call
endCallBtn.onclick = () => {
  endCall();

  // Reset buttons
  startBtn.hidden = false;
  skipBtn.hidden = true;
  endCallBtn.hidden = true;
  switchCamBtn.hidden = true;

  preferences.hidden = false;
};

// Switch Camera
switchCamBtn.onclick = async () => {
  usingFront = !usingFront;
  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
  }
  await startLocalStream();

  // Replace track if call in progress
  if (peerConnection && partnerSocketId) {
    const videoSender = peerConnection.getSenders().find(s => s.track.kind === 'video');
    if (videoSender) {
      videoSender.replaceTrack(localStream.getVideoTracks()[0]);
    }
  }
};

// === STREAM & MATCH ===

async function startLocalStream() {
  localStream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: usingFront ? 'user' : 'environment' },
    audio: true
  });
  localVideo.srcObject = localStream;
}

function findMatch() {
  socket.emit('find_match', {
    selfGender: selfGenderSelect.value,
    age: ageInput.value || 'unknown',
    partnerGender: genderSelect.value,
    partnerLocation: locationSelect.value
  });
}

// === SIGNALING ===

socket.on('match_found', async ({ socketId }) => {
  partnerSocketId = socketId;
  createPeerConnection();

  if (socketId > socket.id) {
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.emit('signal', { to: socketId, data: offer });
  }
});

socket.on('signal', async ({ from, data }) => {
  partnerSocketId = from;
  if (!peerConnection) createPeerConnection();

  if (data.type === 'offer') {
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.emit('signal', { to: from, data: answer });
  } else if (data.type === 'answer') {
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data));
  } else if (data.candidate) {
    await peerConnection.addIceCandidate(new RTCIceCandidate(data));
  }
});

// === PEER CONNECTION ===

function createPeerConnection() {
  peerConnection = new RTCPeerConnection(iceConfig);

  peerConnection.onicecandidate = e => {
    if (e.candidate) {
      socket.emit('signal', { to: partnerSocketId, data: e.candidate });
    }
  };

  peerConnection.ontrack = e => {
    remoteVideo.srcObject = e.streams[0];
  };

  peerConnection.onconnectionstatechange = () => {
    if (['disconnected', 'failed'].includes(peerConnection.connectionState)) {
      endCall();
      findMatch();
    }
  };
}

// === END CALL ===

function endCall() {
  if (peerConnection) {
    peerConnection.close();
    peerConnection = null;
  }
  remoteVideo.srcObject = null;

  if (partnerSocketId) {
    socket.emit('end_call', { to: partnerSocketId });
    partnerSocketId = null;
  }
}
  </script>
</body>
</html>